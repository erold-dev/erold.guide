---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
}

const { title, description = 'The open encyclopedia of development guidelines. Best practices for every framework, accessible to humans and AI agents.', ogImage } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const currentPath = Astro.url.pathname;

const navLinks = [
  { href: '/explore', label: 'Explore' },
  { href: '/api', label: 'API' },
  { href: '/contribute', label: 'Contribute' },
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" href="/favicon.ico" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="erold.guide" />

    <!-- Android / PWA -->
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#14b8a6" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0d9488" media="(prefers-color-scheme: dark)" />

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#14b8a6" />
    <meta name="msapplication-TileImage" content="/mstile-150x150.png" />

    <link rel="canonical" href={canonicalURL} />

    <!-- Primary Meta Tags -->
    <title>{title} | erold.guide</title>
    <meta name="title" content={`${title} | erold.guide`} />
    <meta name="description" content={description} />
    <meta name="keywords" content="development guidelines, best practices, coding standards, framework guidelines, API documentation, developer resources" />
    <meta name="author" content="erold.guide" />
    <meta name="robots" content="index, follow" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | erold.guide`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage || 'https://erold.guide/og-image.png'} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="erold.guide - The open encyclopedia of development guidelines" />
    <meta property="og:site_name" content="erold.guide" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={`${title} | erold.guide`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage || 'https://erold.guide/og-image.png'} />
    <meta name="twitter:image:alt" content="erold.guide - The open encyclopedia of development guidelines" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />

    <!-- Theme Script (runs before render to prevent flash) -->
    <script is:inline>
      (function() {
        const stored = localStorage.getItem('erold-theme');
        if (stored) {
          document.documentElement.setAttribute('data-theme', stored);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      })();
    </script>
  </head>
  <body class="min-h-screen antialiased">
    <!-- Skip to main content - Accessibility -->
    <a href="#main-content" class="skip-link">
      Skip to main content
    </a>

    <div class="relative flex min-h-screen flex-col">
      <!-- Header -->
      <header class="sticky top-0 z-50 border-b" style="border-color: var(--border-secondary); background: var(--bg-primary);">
        <div class="mx-auto flex h-16 max-w-6xl items-center justify-between px-4 sm:px-6">
          <!-- Logo -->
          <a href="/" class="flex items-center gap-2.5 group" aria-label="erold.guide home">
            <img
              src="/favicon.svg"
              alt=""
              width="36"
              height="36"
              class="w-9 h-9"
              aria-hidden="true"
            />
            <span class="font-mono font-semibold text-base" style="color: var(--text-primary);">
              erold<span style="color: var(--accent-primary);">.guide</span>
            </span>
          </a>

          <!-- Navigation -->
          <nav class="hidden sm:flex items-center" role="navigation" aria-label="Main navigation">
            {navLinks.map((link) => (
              <a
                href={link.href}
                class:list={[
                  "nav-link font-mono text-sm",
                  currentPath.startsWith(link.href) && "nav-link-active"
                ]}
                aria-current={currentPath.startsWith(link.href) ? "page" : undefined}
              >
                {link.label}
              </a>
            ))}
          </nav>

          <!-- Right side actions -->
          <div class="flex items-center gap-2">
            <!-- Search trigger -->
            <button
              id="search-trigger"
              type="button"
              class="btn-icon"
              aria-label="Search guidelines (Command+K)"
              aria-keyshortcuts="Control+K Meta+K"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span class="sr-only">Search</span>
            </button>

            <!-- Theme toggle -->
            <button
              id="theme-toggle"
              type="button"
              class="theme-toggle"
              aria-label="Toggle dark mode"
            >
              <!-- Sun icon (shown in dark mode) -->
              <svg class="icon-moon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
              <!-- Moon icon (shown in light mode) -->
              <svg class="icon-sun w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              <span class="sr-only">Toggle theme</span>
            </button>

            <!-- Mobile menu button -->
            <button
              id="mobile-menu-toggle"
              type="button"
              class="btn-icon sm:hidden"
              aria-label="Open menu"
              aria-expanded="false"
              aria-controls="mobile-menu"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile navigation -->
        <nav
          id="mobile-menu"
          class="hidden sm:hidden border-t"
          style="border-color: var(--border-secondary); background: var(--bg-secondary);"
          role="navigation"
          aria-label="Mobile navigation"
        >
          <div class="px-4 py-3 space-y-1">
            {navLinks.map((link) => (
              <a
                href={link.href}
                class:list={[
                  "block py-3 px-4 rounded-lg font-medium transition-colors",
                  currentPath.startsWith(link.href)
                    ? "bg-[var(--color-info-bg)] text-[var(--color-info)]"
                    : "text-[var(--text-secondary)] hover:bg-[var(--surface-hover)] hover:text-[var(--text-primary)]"
                ]}
                aria-current={currentPath.startsWith(link.href) ? "page" : undefined}
              >
                {link.label}
              </a>
            ))}
          </div>
        </nav>
      </header>

      <!-- Main content -->
      <main id="main-content" class="flex-1 relative" tabindex="-1">
        <slot />
      </main>

      <!-- Footer -->
      <footer class="relative border-t mt-12" style="border-color: var(--border-secondary); background: var(--bg-secondary);">
        <div class="mx-auto max-w-6xl px-4 py-8 sm:px-6">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <nav class="flex items-center gap-6 font-mono text-sm" aria-label="Footer navigation">
              <a href="/explore" class="hover:underline" style="color: var(--text-secondary);">Explore</a>
              <a href="/api" class="hover:underline" style="color: var(--text-secondary);">API</a>
              <a href="/contribute" class="hover:underline" style="color: var(--text-secondary);">Contribute</a>
            </nav>
            <p class="font-mono text-sm" style="color: var(--text-muted);">
              MIT License Â· Part of <a href="https://erold.dev" class="hover:underline" style="color: var(--color-primary-600);">erold</a>
            </p>
          </div>
        </div>
      </footer>
    </div>

    <!-- Search Modal -->
    <div
      id="search-modal"
      class="hidden fixed inset-0 z-[100]"
      role="dialog"
      aria-modal="true"
      aria-labelledby="search-modal-title"
    >
      <div class="modal-backdrop" id="search-backdrop"></div>
      <div class="fixed inset-x-4 top-[10%] sm:inset-x-auto sm:left-1/2 sm:-translate-x-1/2 sm:w-full sm:max-w-xl z-[101]">
        <div class="rounded-xl overflow-hidden shadow-2xl" style="background: var(--bg-primary); border: 1px solid var(--border-primary);">
          <div class="relative">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input
              type="search"
              id="search-input"
              class="w-full py-4 pl-12 pr-4 text-lg border-0 outline-none"
              style="background: transparent; color: var(--text-primary);"
              placeholder="Search guidelines..."
              aria-label="Search guidelines"
            />
            <button
              type="button"
              id="search-close"
              class="absolute right-3 top-1/2 -translate-y-1/2 btn-icon"
              aria-label="Close search"
            >
              <kbd class="kbd">Esc</kbd>
            </button>
          </div>
          <div id="search-results" class="border-t max-h-[60vh] overflow-auto" style="border-color: var(--border-secondary);">
            <div class="p-4">
              <p class="text-sm font-medium mb-3" style="color: var(--text-muted);">Quick links</p>
              <div class="space-y-1">
                <a href="/" class="flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-[var(--surface-hover)]">
                  <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                  </svg>
                  <span style="color: var(--text-primary);">Home</span>
                </a>
                <a href="/explore" class="flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-[var(--surface-hover)]">
                  <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  <span style="color: var(--text-primary);">Explore Guidelines</span>
                </a>
                <a href="/api" class="flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-[var(--surface-hover)]">
                  <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                  </svg>
                  <span style="color: var(--text-primary);">API Documentation</span>
                </a>
                <a href="/contribute" class="flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-[var(--surface-hover)]">
                  <svg class="w-5 h-5" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  <span style="color: var(--text-primary);">Contribute</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Theme toggle
      const themeToggle = document.getElementById('theme-toggle');

      function setTheme(theme: string) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('erold-theme', theme);

        // Update aria-label
        themeToggle?.setAttribute(
          'aria-label',
          theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'
        );
      }

      themeToggle?.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const isDark = current === 'dark' ||
          (!current && window.matchMedia('(prefers-color-scheme: dark)').matches);
        setTheme(isDark ? 'light' : 'dark');
      });

      // Listen for system preference changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('erold-theme')) {
          document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
        }
      });

      // Mobile menu toggle
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');

      mobileMenuToggle?.addEventListener('click', () => {
        const isOpen = !mobileMenu?.classList.contains('hidden');
        mobileMenu?.classList.toggle('hidden');
        mobileMenuToggle?.setAttribute('aria-expanded', String(!isOpen));
        mobileMenuToggle?.setAttribute('aria-label', isOpen ? 'Open menu' : 'Close menu');
      });

      // Search modal
      const searchTrigger = document.getElementById('search-trigger');
      const searchModal = document.getElementById('search-modal');
      const searchBackdrop = document.getElementById('search-backdrop');
      const searchClose = document.getElementById('search-close');
      const searchInput = document.getElementById('search-input') as HTMLInputElement;

      function openSearch() {
        searchModal?.classList.remove('hidden');
        searchInput?.focus();
        document.body.style.overflow = 'hidden';
      }

      function closeSearch() {
        searchModal?.classList.add('hidden');
        document.body.style.overflow = '';
      }

      searchTrigger?.addEventListener('click', openSearch);
      searchBackdrop?.addEventListener('click', closeSearch);
      searchClose?.addEventListener('click', closeSearch);

      document.addEventListener('keydown', (e) => {
        // Open search with Cmd/Ctrl + K
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (searchModal?.classList.contains('hidden')) {
            openSearch();
          } else {
            closeSearch();
          }
        }
        // Close with Escape
        if (e.key === 'Escape' && !searchModal?.classList.contains('hidden')) {
          closeSearch();
        }
      });

      // Focus trap for search modal
      searchModal?.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          const focusable = searchModal.querySelectorAll<HTMLElement>(
            'input, button, a[href], [tabindex]:not([tabindex="-1"])'
          );
          const first = focusable[0];
          const last = focusable[focusable.length - 1];

          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last?.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first?.focus();
          }
        }
      });
    </script>
  </body>
</html>
