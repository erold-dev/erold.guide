---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Contribute" description="Submit development guidelines to help developers and AI agents.">
  <div class="page-layout">
    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="page-header">
        <h1>Contribute</h1>
        <p>Submit guidelines to help developers and AI agents write better code.</p>
      </header>

      <!-- Auth Section -->
      <div id="auth-section" class="auth-section">
        <!-- Guest State -->
        <div id="auth-guest" class="auth-box">
          <div class="auth-box-content">
            <h2>Sign in to contribute</h2>
            <p>Authenticate with GitHub to submit and manage your guidelines.</p>
          </div>
          <a href="https://github.com/login/oauth/authorize?client_id=Ov23liLHag386GqnigoM&redirect_uri=https%3A%2F%2Ferold.guide%2Fauth%2Fcallback&scope=read:user" class="btn-primary">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            Sign in with GitHub
          </a>
        </div>

        <!-- User State -->
        <div id="auth-user" class="hidden">
          <div class="user-header">
            <div class="user-info">
              <img id="user-avatar" src="" alt="" class="user-avatar" />
              <div>
                <span id="user-name" class="user-name"></span>
                <button id="sign-out" class="sign-out">Sign out</button>
              </div>
            </div>
            <div class="user-actions">
              <a href="/contribute/submit" class="btn-primary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Submit Guideline
              </a>
              <a id="admin-link" href="/admin" class="hidden btn-secondary">Admin</a>
            </div>
          </div>
        </div>
      </div>

      <!-- My Contributions -->
      <section id="my-contributions" class="hidden contributions-section">
        <div class="section-header">
          <h2>My Contributions</h2>
          <a href="/contribute/submit" class="section-link">+ New</a>
        </div>

        <div id="contributions-loading" class="loading-state">
          <svg class="spinner" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>

        <div id="contributions-empty" class="hidden empty-state">
          <p>No contributions yet.</p>
          <a href="/contribute/submit" class="btn-primary">Submit your first</a>
        </div>

        <div id="contributions-list" class="hidden contributions-list"></div>

        <div id="contributions-error" class="hidden error-state">
          <p>Failed to load contributions.</p>
        </div>
      </section>
    </main>

    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Quick Actions -->
      <div class="sidebar-box">
        <h3>Resources</h3>
        <div class="sidebar-links">
          <a href="/guidelines/erold/contributing/how-to-write-guidelines" class="sidebar-link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Style Guide
          </a>
          <a href="/contribute/api" class="sidebar-link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
            API Documentation
          </a>
          <a href="/explore" class="sidebar-link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            Browse Guidelines
          </a>
        </div>
      </div>

      <!-- Status Legend -->
      <div class="sidebar-box">
        <h3>Status Guide</h3>
        <div class="status-list">
          <div class="status-item">
            <span class="status-dot status-pending"></span>
            <span>Pending review</span>
          </div>
          <div class="status-item">
            <span class="status-dot status-changes"></span>
            <span>Needs changes</span>
          </div>
          <div class="status-item">
            <span class="status-dot status-approved"></span>
            <span>Approved</span>
          </div>
          <div class="status-item">
            <span class="status-dot status-rejected"></span>
            <span>Rejected</span>
          </div>
        </div>
      </div>

      <!-- Tips -->
      <div class="sidebar-box sidebar-box-muted">
        <h3>Quick Tips</h3>
        <ul class="tips-list">
          <li>Be specific and actionable</li>
          <li>Include code examples</li>
          <li>Explain the "why"</li>
          <li>Check for duplicates first</li>
        </ul>
      </div>
    </aside>
  </div>
</BaseLayout>

<style>
  /* Utilities */
  .hidden {
    display: none !important;
  }

  /* Two-column layout - matches header/footer max-w-6xl */
  .page-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 2.5rem;
    max-width: 72rem;
    margin: 0 auto;
    padding: 2rem 1rem;
    align-items: start;
  }

  @media (min-width: 640px) {
    .page-layout {
      padding: 2rem 1.5rem;
    }
  }

  @media (max-width: 1024px) {
    .page-layout {
      grid-template-columns: 1fr;
    }

    .sidebar {
      display: none;
    }
  }

  /* Main content */
  .main-content {
    min-width: 0;
  }

  .page-header {
    margin-bottom: 1.5rem;
  }

  .page-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .page-header p {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  /* Auth Section */
  .auth-section {
    margin-bottom: 2rem;
  }

  .auth-box {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
    padding: 1.25rem;
    border-radius: 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
  }

  .auth-box-content h2 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.125rem;
  }

  .auth-box-content p {
    font-size: 0.8125rem;
    color: var(--text-muted);
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: white;
    background: var(--accent-primary);
    border-radius: 0.5rem;
    text-decoration: none;
    white-space: nowrap;
    transition: opacity 0.15s;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 0.5rem;
    text-decoration: none;
    white-space: nowrap;
  }

  /* User Header */
  .user-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .user-avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
  }

  .user-name {
    display: block;
    font-family: monospace;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
  }

  .sign-out {
    font-size: 0.75rem;
    color: var(--text-muted);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .sign-out:hover {
    text-decoration: underline;
  }

  .user-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Contributions Section */
  .contributions-section {
    margin-top: 1.5rem;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .section-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .section-link {
    font-size: 0.8125rem;
    color: var(--accent-primary);
    text-decoration: none;
  }

  .section-link:hover {
    text-decoration: underline;
  }

  .loading-state {
    padding: 2rem;
    text-align: center;
  }

  .spinner {
    width: 1.5rem;
    height: 1.5rem;
    color: var(--accent-primary);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state {
    padding: 2rem;
    text-align: center;
    background: var(--bg-secondary);
    border-radius: 0.75rem;
    border: 1px solid var(--border-primary);
  }

  .empty-state p {
    color: var(--text-muted);
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .error-state {
    padding: 1rem;
    text-align: center;
    background: var(--status-error-bg);
    border: 1px solid var(--status-error-border);
    border-radius: 0.5rem;
  }

  .error-state p {
    color: var(--status-error);
    font-size: 0.875rem;
  }

  .contributions-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Sidebar */
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: sticky;
    top: 5rem;
  }

  .sidebar-box {
    padding: 1rem;
    border-radius: 0.75rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
  }

  .sidebar-box-muted {
    background: var(--bg-primary);
  }

  .sidebar-box h3 {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
  }

  .sidebar-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .sidebar-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    margin: -0.25rem -0.5rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: background 0.15s, color 0.15s;
  }

  .sidebar-link:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
  }

  /* Status List */
  .status-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }

  .status-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
  }

  .status-pending { background: #3b82f6; }
  .status-changes { background: #f59e0b; }
  .status-approved { background: #10b981; }
  .status-rejected { background: #ef4444; }

  /* Tips List */
  .tips-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .tips-list li {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    padding-left: 0.875rem;
    position: relative;
  }

  .tips-list li::before {
    content: "â€¢";
    position: absolute;
    left: 0;
    color: var(--text-muted);
  }

  @media (max-width: 640px) {
    .auth-box {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
    }

    .user-header {
      flex-direction: column;
      gap: 1rem;
    }

    .user-actions {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  const API_URL = 'https://su5t4tzra5.execute-api.eu-west-1.amazonaws.com';

  async function checkAuth() {
    const token = localStorage.getItem('erold_token');
    const userJson = localStorage.getItem('erold_user');

    const guestEl = document.getElementById('auth-guest');
    const userEl = document.getElementById('auth-user');
    const avatarEl = document.getElementById('user-avatar') as HTMLImageElement;
    const nameEl = document.getElementById('user-name');
    const signOutBtn = document.getElementById('sign-out');
    const myContributions = document.getElementById('my-contributions');
    const adminLink = document.getElementById('admin-link');

    if (token && userJson) {
      try {
        const user = JSON.parse(userJson);
        if (avatarEl) avatarEl.src = user.avatar;
        if (nameEl) nameEl.textContent = user.username;
        guestEl?.classList.add('hidden');
        userEl?.classList.remove('hidden');

        try {
          const adminResponse = await fetch(`${API_URL}/v1/admin/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (adminResponse.ok) {
            const adminData = await adminResponse.json();
            if (adminData.isAdmin) {
              adminLink?.classList.remove('hidden');
            }
          }
        } catch { /* Not admin */ }

        myContributions?.classList.remove('hidden');
        await loadContributions(token);
      } catch {
        localStorage.removeItem('erold_token');
        localStorage.removeItem('erold_user');
      }
    }

    signOutBtn?.addEventListener('click', () => {
      localStorage.removeItem('erold_token');
      localStorage.removeItem('erold_user');
      window.location.reload();
    });
  }

  async function loadContributions(token: string) {
    const loading = document.getElementById('contributions-loading');
    const empty = document.getElementById('contributions-empty');
    const list = document.getElementById('contributions-list');
    const error = document.getElementById('contributions-error');

    try {
      const response = await fetch(`${API_URL}/v1/contributions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Failed to fetch');

      const data = await response.json();
      loading?.classList.add('hidden');

      if (!data.contributions || data.contributions.length === 0) {
        empty?.classList.remove('hidden');
        return;
      }

      list?.classList.remove('hidden');
      if (list) list.innerHTML = data.contributions.map((c: any) => `
        <a href="${['pending', 'ai_needs_changes', 'admin_needs_changes'].includes(c.status) ? `/contribute/submit?edit=${c.id}` : '#'}" class="contribution-row">
          <div class="contribution-main">
            <span class="contribution-title">${escapeHtml(c.title)}</span>
            <span class="contribution-meta">${c.topic} / ${c.category.replace(/-/g, ' ')}</span>
          </div>
          <span class="contribution-status ${getStatusClass(c.status)}">${formatStatus(c.status)}</span>
        </a>
      `).join('');

    } catch (err) {
      console.error('Failed to load contributions:', err);
      loading?.classList.add('hidden');
      error?.classList.remove('hidden');
    }
  }

  function getStatusClass(status: string): string {
    switch (status) {
      case 'pending': return 'status-pending-badge';
      case 'ai_approved':
      case 'approved': return 'status-approved-badge';
      case 'ai_needs_changes':
      case 'admin_needs_changes': return 'status-changes-badge';
      case 'rejected': return 'status-rejected-badge';
      default: return '';
    }
  }

  function formatStatus(status: string): string {
    return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  checkAuth();
</script>

<style is:global>
  .contribution-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: border-color 0.15s;
  }

  .contribution-row:hover {
    border-color: var(--border-secondary);
  }

  .contribution-main {
    min-width: 0;
    flex: 1;
  }

  .contribution-title {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .contribution-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .contribution-status {
    font-size: 0.6875rem;
    font-family: monospace;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    white-space: nowrap;
  }

  .status-pending-badge {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
  }

  .status-approved-badge {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
  }

  .status-changes-badge {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
  }

  .status-rejected-badge {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }
</style>
