---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getGuidelines, getGuideline, getTopic, getRelatedGuidelines } from '../../lib/content';
import { marked } from 'marked';

export function getStaticPaths() {
  const guidelines = getGuidelines();
  return guidelines.map((g) => ({
    params: { path: `${g.topic}/${g.category}/${g.slug}` },
  }));
}

const { path } = Astro.params;
const [topic, category, slug] = path.split('/');

const guideline = getGuideline(topic, category, slug);
const topicData = getTopic(topic);

if (!guideline) {
  return Astro.redirect('/404');
}

const relatedGuidelines = guideline ? getRelatedGuidelines(guideline) : [];

const htmlContent = await marked.parse(guideline.content);
---

<BaseLayout title={guideline.title} description={guideline.description}>
  <div class="mx-auto max-w-4xl px-4 py-8 sm:px-6">
    <!-- Breadcrumb -->
    <nav class="font-mono text-xs mb-6" style="color: var(--text-muted);">
      <a href="/explore" class="hover:underline" style="color: var(--text-secondary);">explore</a>
      <span class="mx-1.5">/</span>
      <a href={`/explore/${topic}`} class="hover:underline" style="color: var(--text-secondary);">{topic}</a>
      <span class="mx-1.5">/</span>
      <span>{category}</span>
      <span class="mx-1.5">/</span>
      <span style="color: var(--text-primary);">{slug}</span>
    </nav>

    <!-- Header -->
    <header class="mb-8 pb-6" style="border-bottom: 1px solid var(--border-secondary);">
      <h1 class="text-2xl font-bold mb-3" style="color: var(--text-primary);">{guideline.title}</h1>
      <p class="text-sm mb-4" style="color: var(--text-secondary);">
        {guideline.description}
      </p>

      <div class="flex flex-wrap items-center gap-3">
        <span class={`difficulty-dot difficulty-${guideline.difficulty}`}></span>
        <span class="text-xs font-medium" style="color: var(--text-muted);">
          {guideline.difficulty}
        </span>
        <span style="color: var(--border-primary);">·</span>
        <span class="text-xs" style="color: var(--text-muted);">
          {guideline.estimatedReadTime} min read
        </span>
        {guideline.deprecated && (
          <>
            <span style="color: var(--border-primary);">·</span>
            <span class="text-xs px-2 py-0.5 rounded" style="background: var(--status-error-bg); color: var(--status-error);">
              deprecated
            </span>
          </>
        )}
        {guideline.minVersion && (
          <>
            <span style="color: var(--border-primary);">·</span>
            <span class="text-xs font-mono" style="color: var(--text-muted);">
              v{guideline.minVersion}+
            </span>
          </>
        )}
      </div>
    </header>

    <!-- Content -->
    <article class="prose" set:html={htmlContent} />

    <!-- Footer -->
    <footer class="mt-12 pt-6" style="border-top: 1px solid var(--border-secondary);">
      <!-- Tags -->
      {guideline.tags.length > 0 && (
        <div class="mb-6">
          <div class="flex flex-wrap gap-2">
            {guideline.tags.map((tag) => (
              <span class="text-xs px-2 py-1 rounded" style="background: var(--bg-tertiary); color: var(--text-muted);">
                {tag}
              </span>
            ))}
          </div>
        </div>
      )}

      <!-- Meta row -->
      <div class="flex flex-wrap items-center gap-4 text-xs" style="color: var(--text-muted);">
        <span>By {guideline.author}</span>
        <span style="color: var(--border-primary);">·</span>
        <span>v{guideline.version}</span>
        <span style="color: var(--border-primary);">·</span>
        <span>Updated {new Date(guideline.updatedAt).toLocaleDateString()}</span>
        <span style="color: var(--border-primary);">·</span>
        <a
          href={`/api/v1/guidelines/${guideline.topic}/${guideline.category}/${guideline.slug}.json`}
          class="hover:underline"
          style="color: var(--text-secondary);"
        >
          API
        </a>
      </div>

      <!-- Related -->
      {relatedGuidelines.length > 0 && (
        <div class="mt-6">
          <h3 class="text-xs font-medium mb-3" style="color: var(--text-muted);">
            Related
          </h3>
          <div class="flex flex-wrap gap-2">
            {relatedGuidelines.map((related) => (
              <a
                href={`/guidelines/${related.topic}/${related.category}/${related.slug}`}
                class="text-xs px-2 py-1 rounded transition-colors"
                style="background: var(--bg-tertiary); color: var(--text-secondary);"
              >
                {related.title}
              </a>
            ))}
          </div>
        </div>
      )}
    </footer>
  </div>
</BaseLayout>

<style>
  .difficulty-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
  }

  .difficulty-dot.difficulty-beginner {
    background: var(--status-success);
  }

  .difficulty-dot.difficulty-intermediate {
    background: var(--status-warning);
  }

  .difficulty-dot.difficulty-advanced {
    background: var(--status-error);
  }
</style>
