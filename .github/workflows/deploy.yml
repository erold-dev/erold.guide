name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1

jobs:
  # Detect what changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      website: ${{ steps.filter.outputs.website }}
      contributions-lambda: ${{ steps.filter.outputs.contributions-lambda }}
      ai-reviewer-lambda: ${{ steps.filter.outputs.ai-reviewer-lambda }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            website:
              - 'src/**'
              - 'content/**'
              - 'public/**'
              - 'astro.config.mjs'
              - 'package.json'
            contributions-lambda:
              - 'infra/lambda/contributions/**'
            ai-reviewer-lambda:
              - 'infra/lambda/ai-reviewer/**'

  # Deploy website (always runs on workflow_dispatch, or when website files change)
  deploy-website:
    needs: changes
    if: ${{ needs.changes.outputs.website == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Website
        run: npm run build:astro

      - name: Build API
        run: npm run build:api

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy API to S3
        run: |
          aws s3 sync dist/api/v1/ s3://erold-guidelines-api/v1/ \
            --delete \
            --content-type "application/json"

      - name: Deploy Website to S3
        run: |
          # Sync all files first
          aws s3 sync dist/ s3://erold-website/ \
            --delete \
            --exclude "api/*"

          # Fix content types for static assets
          aws s3 cp s3://erold-website/_astro/ s3://erold-website/_astro/ \
            --recursive \
            --exclude "*" \
            --include "*.css" \
            --content-type "text/css" \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable"

          aws s3 cp s3://erold-website/_astro/ s3://erold-website/_astro/ \
            --recursive \
            --exclude "*" \
            --include "*.js" \
            --content-type "application/javascript" \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable"

      - name: Invalidate CloudFront caches
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E2Z2A14SC6AOFW \
            --paths "/*"
          aws cloudfront create-invalidation \
            --distribution-id E1JEAAW1UUUT5Z \
            --paths "/*"

  # Deploy contributions Lambda
  deploy-contributions-lambda:
    needs: changes
    if: ${{ needs.changes.outputs.contributions-lambda == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Package Lambda
        run: |
          cd infra/lambda/contributions
          zip -r ../contributions.zip index.mjs

      - name: Deploy Lambda
        run: |
          aws lambda update-function-code \
            --function-name erold-contributions-api \
            --zip-file fileb://infra/lambda/contributions.zip

      - name: Update Lambda configuration
        run: |
          aws lambda update-function-configuration \
            --function-name erold-contributions-api \
            --environment "Variables={
              TABLE_NAME=erold-contributions,
              PENDING_BUCKET=erold-contributions-pending,
              GUIDELINES_BUCKET=erold-guide-content,
              GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }},
              GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }},
              JWT_SECRET=${{ secrets.JWT_SECRET }},
              AI_REVIEWER_FUNCTION=erold-ai-reviewer,
              ADMIN_USERS=${{ secrets.ADMIN_USERS }}
            }"

  # Deploy AI reviewer Lambda
  deploy-ai-reviewer-lambda:
    needs: changes
    if: ${{ needs.changes.outputs.ai-reviewer-lambda == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Package Lambda
        run: |
          cd infra/lambda/ai-reviewer
          zip -r ../ai-reviewer.zip index.mjs

      - name: Deploy Lambda
        run: |
          aws lambda update-function-code \
            --function-name erold-ai-reviewer \
            --zip-file fileb://infra/lambda/ai-reviewer.zip

      - name: Update Lambda configuration
        run: |
          aws lambda update-function-configuration \
            --function-name erold-ai-reviewer \
            --environment "Variables={
              TABLE_NAME=erold-contributions,
              PENDING_BUCKET=erold-contributions-pending,
              GUIDELINES_BUCKET=erold-guide-content,
              ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
            }"
